import cv2
import mediapipe as mp
import numpy as np
import sqlite3
import base64

# 데이터베이스 초기화
# SQLite 데이터베이스에 연결하고 커서를 생성합니다.
conn = sqlite3.connect('faces.db')
c = conn.cursor()

# 'faces' 테이블이 없으면 생성합니다. 이 테이블은 id와 face_data 열로 구성됩니다.
c.execute('''CREATE TABLE IF NOT EXISTS faces
             (id INTEGER PRIMARY KEY AUTOINCREMENT, face_data TEXT)''')
conn.commit()

# MediaPipe Face Mesh 모델 초기화
# MediaPipe의 Face Mesh 솔루션을 사용하여 얼굴의 468개 특징점을 검출합니다.
mp_face_mesh = mp.solutions.face_mesh
face_mesh = mp_face_mesh.FaceMesh(max_num_faces=1, min_detection_confidence=0.5)

# OpenCV를 사용하여 웹캠에서 실시간 영상 가져오기
cap = cv2.VideoCapture(0)

def face_to_str(face):
    """
    얼굴 이미지를 Base64 문자열로 변환하는 함수.
    """
    _, buffer = cv2.imencode('.jpg', face)
    face_str = base64.b64encode(buffer).decode('utf-8')
    return face_str

def is_face_in_db(face_str):
    """
    주어진 얼굴 문자열이 데이터베이스에 존재하는지 확인하는 함수.
    """
    c.execute("SELECT * FROM faces WHERE face_data = ?", (face_str,))
    return c.fetchone() is not None

while cap.isOpened():
    success, frame = cap.read()
    if not success:
        break

    # 프레임을 RGB로 변환 (MediaPipe는 RGB 이미지를 사용)
    rgb_frame = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
    
    # 얼굴 특징점 검출
    results = face_mesh.process(rgb_frame)

    if results.multi_face_landmarks:
        for face_landmarks in results.multi_face_landmarks:
            # 얼굴 영역 추출 (간단한 방식으로 얼굴 영역을 추출)
            ih, iw, _ = frame.shape
            face_x_min = int(min([landmark.x for landmark in face_landmarks.landmark]) * iw)
            face_y_min = int(min([landmark.y for landmark in face_landmarks.landmark]) * ih)
            face_x_max = int(max([landmark.x for landmark in face_landmarks.landmark]) * iw)
            face_y_max = int(max([landmark.y for landmark in face_landmarks.landmark]) * ih)

            # 추출된 얼굴 영역을 자릅니다.
            face_crop = frame[face_y_min:face_y_max, face_x_min:face_x_max]
            
            # 얼굴 이미지를 문자열로 변환합니다.
            face_str = face_to_str(face_crop)

            # 데이터베이스에 얼굴 이미지가 존재하는지 확인합니다.
            if is_face_in_db(face_str):
                print("hello world")
            else:
                # 얼굴 이미지가 데이터베이스에 존재하지 않으면 저장합니다.
                c.execute("INSERT INTO faces (face_data) VALUES (?)", (face_str,))
                conn.commit()
                
                # 얼굴 이미지를 파일로 저장합니다.
                cv2.imwrite(f"captured_face_{len(c.execute('SELECT * FROM faces').fetchall())}.jpg", face_crop)

    # 얼굴 특징점을 포함한 프레임을 화면에 표시합니다.
    cv2.imshow('Face Detection', frame)
    
    # 'Esc' 키를 누르면 루프를 종료합니다.
    if cv2.waitKey(5) & 0xFF == 27:
        break

# 자원 해제 및 정리
cap.release()
cv2.destroyAllWindows()
conn.close()